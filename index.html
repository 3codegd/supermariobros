<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>SMB NES Level Editor</title>
<style>
  body { margin:0; display:flex; font-family:sans-serif; background:#222; color:#ddd; }
  #sidebar { width:260px; background:#2b2b2b; padding:10px; box-sizing:border-box; overflow-y:auto; }
  #sidebar button, #sidebar select, #sidebar input { width:100%; margin:4px 0; }
  #paletteTabs { display:flex; margin-bottom:4px; }
  .tab { flex:1; padding:4px; text-align:center; cursor:pointer; background:#444; border:1px solid #333; }
  .tab.active { background:#0af; color:#000; }
  #palette { display:grid; grid-template-columns: repeat(4, 48px); gap:4px; max-height:200px; overflow-y:auto; }
  .pal { width:48px; height:48px; border:1px solid #555; background:#000; cursor:pointer; image-rendering: pixelated; }
  .pal.selected { border:2px solid #0af; }
  #preview { width:64px; height:64px; border:1px solid #555; background:#000; margin-bottom:10px; image-rendering: pixelated; }
  #canvasWrap { flex:1; background:#5c94fc; overflow:auto; }
  canvas { image-rendering: pixelated; display:block; border:4px solid #000; }
</style>
</head>
<body>
<div id="sidebar">
  <h3>Theme</h3>
  <select id="themeSelect">
    <option value="overworld">Overworld</option>
    <option value="underworld">Underworld</option>
    <option value="castle">Castle</option>
    <option value="underwater">Underwater</option>
  </select>
  <audio id="themeAudio" loop></audio>

  <h3>Palette</h3>
  <div id="paletteTabs"></div>
  <div id="palette"></div>
  <div id="preview"></div>

  <h4>Tools</h4>
  <button id="paintBtn">Paint</button>
  <button id="eraseBtn">Erase</button>
  <button id="pickBtn">Pick</button>
  <button id="fillBtn">Fill</button>
  <hr/>
  <button id="clearBtn">Clear Level</button>
  <button id="undoBtn">Undo</button>
  <button id="redoBtn">Redo</button>
  <hr/>
  <button id="saveBtn">Download JSON</button>
  <button id="loadBtn">Load JSON</button>
  <input type="file" id="fileInput" style="display:none"/>
  <button id="exportBtn">Export PNG</button>
  <hr/>
  <button id="playBtn">Playtest</button>
  <button id="stopBtn" disabled>Stop</button>
</div>

<div id="canvasWrap">
  <canvas id="editor"></canvas>
</div>

<script>
// --- Config
const TILESET_URL = '/main/tileset.png';
const TILE_W = 16, TILE_H = 16;
const VISIBLE_COLS = 28, VISIBLE_ROWS = 15;
const TOTAL_COLS = 400;
let tilesetImage = new Image();
tilesetImage.crossOrigin = 'anonymous';

let tiles=[], level=[], undoStack=[], redoStack=[];
let selectedTile=0, tool='paint', cameraX=0, scale=2;
let theme = 'overworld';
const themePalettes = {
  overworld: {ground:[0,1,2], objects:[3,4,5]}, 
  underworld: {ground:[6,7,8], objects:[9,10,11]},
  castle: {ground:[12,13,14], objects:[15,16,17]},
  underwater: {ground:[18,19,20], objects:[21,22,23]}
};
const categoryNames = {ground:'Ground', objects:'Objects'};

// --- Setup level
for(let y=0;y<VISIBLE_ROWS;y++) level[y]=Array(TOTAL_COLS).fill(-1);

// --- Canvas
const canvas=document.getElementById('editor');
const ctx=canvas.getContext('2d');
function resizeCanvas(){canvas.width=VISIBLE_COLS*TILE_W*scale; canvas.height=VISIBLE_ROWS*TILE_H*scale;}
resizeCanvas();

// --- Load tileset
tilesetImage.onload = () => {
  const cols = Math.floor(tilesetImage.width / TILE_W);
  const rows = Math.floor(tilesetImage.height / TILE_H);
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      const c=document.createElement('canvas'); c.width=TILE_W; c.height=TILE_H;
      const ctx2=c.getContext('2d'); ctx2.imageSmoothingEnabled=false;
      ctx2.drawImage(tilesetImage, x*TILE_W, y*TILE_H, TILE_W, TILE_H, 0, 0, TILE_W, TILE_H);
      tiles.push(c);
    }
  }
  buildPaletteTabs();
  selectTheme(theme);
  draw();
};
tilesetImage.src = TILESET_URL;

// --- Palette tabs
const paletteDiv=document.getElementById('palette');
const paletteTabsDiv=document.getElementById('paletteTabs');
function buildPaletteTabs(){
  paletteTabsDiv.innerHTML='';
  for(const cat in categoryNames){
    const b=document.createElement('div');
    b.className='tab';
    b.textContent=categoryNames[cat];
    b.dataset.cat=cat;
    b.onclick=()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); buildPalette();};
    paletteTabsDiv.appendChild(b);
  }
  paletteTabsDiv.firstChild.classList.add('active');
}

// --- Build palette for current theme & category
let currentCategory='ground';
function buildPalette(){
  paletteDiv.innerHTML='';
  const catTiles = themePalettes[theme][currentCategory];
  catTiles.forEach(idx=>{
    const cDiv=document.createElement('div'); cDiv.className='pal'; cDiv.dataset.idx=idx;
    const cCanvas=document.createElement('canvas'); cCanvas.width=TILE_W*2; cCanvas.height=TILE_H*2;
    cCanvas.style.width=(TILE_W*2)+'px'; cCanvas.style.height=(TILE_H*2)+'px';
    const pc=cCanvas.getContext('2d'); pc.imageSmoothingEnabled=false;
    pc.drawImage(tiles[idx],0,0);
    cDiv.appendChild(cCanvas);
    cDiv.onclick=()=>{
      selectedTile=idx;
      document.querySelectorAll('.pal').forEach(x=>x.classList.remove('selected'));
      cDiv.classList.add('selected');
      updatePreview();
    };
    paletteDiv.appendChild(cDiv);
  });
  paletteDiv.firstChild.click();
}

// --- Preview
function updatePreview(){
  const prev=document.getElementById('preview'); prev.innerHTML='';
  const c=document.createElement('canvas'); c.width=TILE_W*scale*2; c.height=TILE_H*scale*2;
  const pc=c.getContext('2d'); pc.imageSmoothingEnabled=false;
  pc.drawImage(tiles[selectedTile],0,0,TILE_W,TILE_H,0,0,c.width,c.height);
  prev.appendChild(c);
}

// --- Theme select
const themeAudio=document.getElementById('themeAudio');
document.getElementById('themeSelect').onchange=e=>{selectTheme(e.target.value);}
function selectTheme(t){
  theme=t;
  themeAudio.src=`/main/${t}.mp3`;
  themeAudio.play();
  currentCategory='ground';
  document.querySelectorAll('.tab').forEach((b,i)=>b.classList.toggle('active', i===0));
  buildPalette();
}

// --- Tools
document.getElementById('paintBtn').onclick   = ()=>setTool('paint');
document.getElementById('eraseBtn').onclick  = ()=>setTool('erase');
document.getElementById('pickBtn').onclick   = ()=>setTool('pick');
document.getElementById('fillBtn').onclick   = ()=>setTool('fill');
function setTool(t){tool=t;}

// --- Draw level
function draw(){
  ctx.imageSmoothingEnabled=false;
  ctx.fillStyle='#75baff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<VISIBLE_ROWS;y++){
    for(let vx=0;vx<VISIBLE_COLS;vx++){
      const lx=vx+cameraX; const t=level[y][lx];
      if(t>=0){
        ctx.drawImage(tiles[t],-1,-1,TILE_W,TILE_H,vx*TILE_W*scale,y*TILE_H*scale,TILE_W*scale,TILE_H*scale);
      }
    }
  }
  ctx.strokeStyle='rgba(0,0,0,0.15)';
  for(let x=0;x<=VISIBLE_COLS;x++){ const px=x*TILE_W*scale+0.5; ctx.beginPath(); ctx.moveTo(px,0); ctx.lineTo(px,canvas.height); ctx.stroke(); }
  for(let y=0;y<=VISIBLE_ROWS;y++){ const py=y*TILE_H*scale+0.5; ctx.beginPath(); ctx.moveTo(0,py); ctx.lineTo(canvas.width,py); ctx.stroke(); }
}

// --- Mouse painting
let isDown=false;
canvas.addEventListener('mousedown', e=>{isDown=true; handlePaint(e); window.addEventListener('mousemove', handlePaint);});
window.addEventListener('mouseup', ()=>{isDown=false; window.removeEventListener('mousemove', handlePaint);});
function handlePaint(e){
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left; const my=e.clientY-rect.top;
  const vx=Math.floor(mx/(TILE_W*scale)); const vy=Math.floor(my/(TILE_H*scale));
  const lx=vx+cameraX; if(lx<0||lx>=TOTAL_COLS||vy<0||vy>=VISIBLE_ROWS) return;
  if(tool==='paint'){level[vy][lx]=selectedTile; draw();}
  else if(tool==='erase'){level[vy][lx]=-1; draw();}
  else if(tool==='pick'){const t=level[vy][lx]; if(t>=0){selectedTile=t; updatePreview();}}
  else if(tool==='fill'){flood(lx,vy,level[vy][lx],selectedTile); draw();}
}
function flood(sx,sy,target,repl){const stack=[[sx,sy]]; while(stack.length){const [x,y]=stack.pop(); if(x<0||x>=TOTAL_COLS||y<0||y>=VISIBLE_ROWS) continue; if(level[y][x]!==target) continue; level[y][x]=repl; stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]); }}

// --- Clear/Undo/Redo
function snapshot(){undoStack.push(level.map(r=>r.slice())); if(undoStack.length>50) undoStack.shift();}
document.getElementById('clearBtn').onclick=()=>{snapshot(); for(let y=0;y<VISIBLE_ROWS;y++) for(let x=0;x<TOTAL_COLS;x++) level[y][x]=-1; draw();}
document.getElementById('undoBtn').onclick=()=>{if(!undoStack.length)return; redoStack.push(level.map(r=>r.slice())); level=undoStack.pop(); draw();}
document.getElementById('redoBtn').onclick=()=>{if(!redoStack.length)return; undoStack.push(level.map(r=>r.slice())); level=redoStack.pop(); draw();}

// --- Save/Load JSON
document.getElementById('saveBtn').onclick=()=>{const blob=new Blob([JSON.stringify({cols:TOTAL_COLS,rows:VISIBLE_ROWS,map:level})],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='level.json'; a.click();}
document.getElementById('loadBtn').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange=e=>{const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{try{const data=JSON.parse(r.result); if(data.map && data.map.length===VISIBLE_ROWS){snapshot(); level=data.map; draw();}else alert('Bad JSON');}catch(err){alert('Error reading JSON:'+err)}}; r.readAsText(f);}

// --- Export PNG
document.getElementById('exportBtn').onclick=()=>{const ex=document.createElement('canvas'); ex.width=canvas.width; ex.height=canvas.height; const ectx=ex.getContext('2d'); ectx.imageSmoothingEnabled=false; ectx.drawImage(canvas,0,0); ex.toBlob(b=>{const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='level.png'; a.click();});}

// --- Camera scroll
window.addEventListener('keydown', e=>{if(e.key==='ArrowLeft')cameraX=Math.max(0,cameraX-1),draw(); if(e.key==='ArrowRight')cameraX=Math.min(TOTAL_COLS-VISIBLE_COLS,cameraX+1),draw();});

// --- Playtest placeholder
let playing=false;
function drawPlayer(){const pw=TILE_W*scale,ph=TILE_H*scale; ctx.fillStyle='red'; ctx.fillRect(0,canvas.height-ph,pw,ph);}
function startPlay(){playing=true; document.getElementById('playBtn').disabled=true; document.getElementById('stopBtn').disabled=false; draw(); drawPlayer();}
function stopPlay(){playing=false; document.getElementById('playBtn').disabled=false; document.getElementById('stopBtn').disabled=true; draw();}
document.getElementById('playBtn').onclick=startPlay;
document.getElementById('stopBtn').onclick=stopPlay;

// --- Tab switching
document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{
  currentCategory=b.dataset.cat;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  b.classList.add('active');
  buildPalette();
});
</script>
</body>
</html>
