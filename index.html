<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>SMB NES Tileset Editor - Theme Tabs</title>
<style>
body { margin:0; display:flex; font-family:sans-serif; background:#222; color:#ddd; }
#sidebar { width:250px; background:#2b2b2b; padding:10px; box-sizing:border-box; display:flex; flex-direction:column; }
#tabs { display:flex; gap:4px; margin-bottom:6px; }
.tab { flex:1; padding:4px; text-align:center; cursor:pointer; background:#444; border-radius:4px; }
.tab.active { background:#0af; font-weight:bold; }
#paletteWrapper { flex:1; overflow:auto; border:1px solid #555; padding:2px; margin-bottom:10px; }
#palette { display:grid; grid-template-columns: repeat(4, 48px); gap:4px; }
.pal { width:48px; height:48px; border:1px solid #555; background:#000; cursor:pointer; image-rendering: pixelated; }
.pal.selected { border:2px solid #0af; }
#preview { width:64px; height:64px; border:1px solid #555; background:#000; margin-bottom:10px; image-rendering: pixelated; }
button,input { width:100%; margin:3px 0; }
#canvasWrap { flex:1; background:#5c94fc; overflow:auto; }
canvas { image-rendering: pixelated; display:block; border:4px solid #000; }
hr { border:0; border-top:1px solid #555; margin:6px 0; }
</style>
</head>
<body>
<div id="sidebar">
  <h3>Theme Palettes</h3>
  <div id="tabs">
    <div class="tab active" data-theme="overworld">Overworld</div>
    <div class="tab" data-theme="underworld">Underworld</div>
    <div class="tab" data-theme="castle">Castle</div>
    <div class="tab" data-theme="underwater">Underwater</div>
  </div>
  <div id="paletteWrapper"><div id="palette"></div></div>
  <div id="preview"></div>

  <h4>Tools</h4>
  <button id="paintBtn">Paint</button>
  <button id="eraseBtn">Erase</button>
  <button id="pickBtn">Pick</button>
  <button id="fillBtn">Fill</button>
  <hr/>
  <button id="clearBtn">Clear Level</button>
  <button id="undoBtn">Undo</button>
  <button id="redoBtn">Redo</button>
  <hr/>
  <button id="saveBtn">Download JSON</button>
  <button id="loadBtn">Load JSON</button>
  <input type="file" id="fileInput" style="display:none"/>
  <button id="exportBtn">Export PNG</button>
  <hr/>
  <button id="playBtn">Playtest</button>
  <button id="stopBtn" disabled>Stop</button>
</div>
<div id="canvasWrap">
  <canvas id="editor"></canvas>
</div>

<script>
// --- Config
const TILESET_URL = '/main/tileset.png';
const TILE_W = 16, TILE_H = 16;
const VISIBLE_COLS = 28, VISIBLE_ROWS = 15;
const TOTAL_COLS = 400;

// --- State
let tilesetImage, tiles = [];
let selectedTile = 0;
let tool = 'paint';
let theme = 'overworld';
let level = [];
let undoStack = [], redoStack = [];

const THEMES = {
  overworld: [0,1,2,3,4,5,6,7,8,9],
  underworld: [10,11,12,13,14,15,16,17,18,19],
  castle: [20,21,22,23,24,25,26,27,28,29],
  underwater: [30,31,32,33,34,35,36,37,38,39]
};

// init level
for (let y=0;y<VISIBLE_ROWS;y++) level[y] = Array(TOTAL_COLS).fill(-1);

// --- Canvas
const canvas = document.getElementById('editor');
const ctx = canvas.getContext('2d');
let cameraX = 0, scale = 2;
canvas.width = VISIBLE_COLS*TILE_W*scale;
canvas.height = VISIBLE_ROWS*TILE_H*scale;

// --- Load & slice tileset (shift 1px up-left)
tilesetImage = new Image();
tilesetImage.crossOrigin = 'anonymous';
tilesetImage.onload = () => {
  const cols = Math.floor((tilesetImage.width -1)/TILE_W);
  const rows = Math.floor((tilesetImage.height-1)/TILE_H);
  for (let ry=0; ry<rows; ry++){
    for (let rx=0; rx<cols; rx++){
      const c = document.createElement('canvas');
      c.width = TILE_W; c.height = TILE_H;
      const cctx = c.getContext('2d');
      cctx.imageSmoothingEnabled = false;
      cctx.drawImage(tilesetImage,
                     rx*TILE_W +1, ry*TILE_H +1, TILE_W, TILE_H,
                     0,0,TILE_W,TILE_H);
      tiles.push(c);
    }
  }
  buildPalette();
  draw();
};
tilesetImage.src = TILESET_URL;

// --- Palette
const paletteDiv = document.getElementById('palette');
function buildPalette(){
  paletteDiv.innerHTML = '';
  THEMES[theme].forEach(i=>{
    if (!tiles[i]) return;
    const d = document.createElement('div');
    d.className = 'pal';
    d.dataset.idx = i;
    const c = document.createElement('canvas');
    c.width = TILE_W*2; c.height = TILE_H*2;
    const pc = c.getContext('2d');
    pc.imageSmoothingEnabled = false;
    pc.drawImage(tiles[i],0,0,TILE_W,TILE_H,0,0,TILE_W*2,TILE_H*2);
    d.appendChild(c);
    d.onclick = ()=>{
      selectedTile = i;
      document.querySelectorAll('.pal').forEach(x=>x.classList.remove('selected'));
      d.classList.add('selected');
      updatePreview();
    };
    paletteDiv.appendChild(d);
  });
  if(paletteDiv.firstChild) paletteDiv.firstChild.click();
}

function updatePreview(){
  const prev = document.getElementById('preview');
  prev.innerHTML = '';
  if (!tiles[selectedTile]) return;
  const c = document.createElement('canvas');
  c.width = TILE_W*scale*2;
  c.height = TILE_H*scale*2;
  const pc = c.getContext('2d');
  pc.imageSmoothingEnabled = false;
  pc.drawImage(tiles[selectedTile],0,0,TILE_W,TILE_H,0,0,c.width,c.height);
  prev.appendChild(c);
}

// --- Draw level
function draw(){
  ctx.imageSmoothingEnabled = false;
  ctx.fillStyle = '#75baff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<VISIBLE_ROWS;y++){
    for(let vx=0;vx<VISIBLE_COLS;vx++){
      const lx = vx+cameraX;
      const t = level[y][lx];
      if(t>=0){
        ctx.drawImage(tiles[t],0,0,TILE_W,TILE_H,
                      vx*TILE_W*scale, y*TILE_H*scale,
                      TILE_W*scale,TILE_H*scale);
      }
    }
  }
  ctx.strokeStyle='rgba(0,0,0,0.15)';
  for(let x=0;x<=VISIBLE_COLS;x++){
    const px=x*TILE_W*scale+0.5; ctx.beginPath(); ctx.moveTo(px,0); ctx.lineTo(px,canvas.height); ctx.stroke();
  }
  for(let y=0;y<=VISIBLE_ROWS;y++){
    const py=y*TILE_H*scale+0.5; ctx.beginPath(); ctx.moveTo(0,py); ctx.lineTo(canvas.width,py); ctx.stroke();
  }
}

// --- Mouse paint
let isDown = false;
canvas.addEventListener('mousedown', e=>{
  isDown=true; handlePaint(e); window.addEventListener('mousemove', handlePaint);
});
window.addEventListener('mouseup', ()=>{ isDown=false; window.removeEventListener('mousemove', handlePaint); });

function handlePaint(e){
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const vx = Math.floor(mx/(TILE_W*scale)), vy=Math.floor(my/(TILE_H*scale));
  const lx = vx + cameraX;
  if(lx<0||lx>=TOTAL_COLS||vy<0||vy>=VISIBLE_ROWS) return;

  if(tool==='paint'){ level[vy][lx]=selectedTile; draw(); }
  else if(tool==='erase'){ level[vy][lx]=-1; draw(); }
  else if(tool==='pick'){ const t=level[vy][lx]; if(t>=0){selectedTile=t; document.querySelector(`[data-idx='${t}']`)?.click(); } }
  else if(tool==='fill'){ const target=level[vy][lx]; flood(lx,vy,target,selectedTile); draw(); }
}

function flood(sx,sy,target,repl){
  const stack=[[sx,sy]];
  while(stack.length){
    const [x,y]=stack.pop();
    if(x<0||x>=TOTAL_COLS||y<0||y>=VISIBLE_ROWS) continue;
    if(level[y][x]!==target) continue;
    level[y][x]=repl;
    stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
  }
}

// --- Tools
document.getElementById('paintBtn').onclick=()=>setTool('paint');
document.getElementById('eraseBtn').onclick=()=>setTool('erase');
document.getElementById('pickBtn').onclick=()=>setTool('pick');
document.getElementById('fillBtn').onclick=()=>setTool('fill');
function setTool(t){ tool=t; }

// --- Clear / undo / redo
function snapshot(){ undoStack.push(level.map(r=>r.slice())); if(undoStack.length>50) undoStack.shift(); }
document.getElementById('clearBtn').onclick=()=>{
  if(!confirm('Clear entire level?')) return;
  snapshot(); for(let y=0;y<VISIBLE_ROWS;y++) for(let x=0;x<TOTAL_COLS;x++) level[y][x]=-1; draw();
};
document.getElementById('undoBtn').onclick=()=>{
  if(!undoStack.length) return; redoStack.push(level.map(r=>r.slice())); level=undoStack.pop(); draw();
};
document.getElementById('redoBtn').onclick=()=>{
  if(!redoStack.length) return; undoStack.push(level.map(r=>r.slice())); level=redoStack.pop(); draw();
};

// --- Save / Load
document.getElementById('saveBtn').onclick=()=>{
  const blob=new Blob([JSON.stringify({cols:TOTAL_COLS,rows:VISIBLE_ROWS,map:level})],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='level.json'; a.click();
};
document.getElementById('loadBtn').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{ const data=JSON.parse(r.result); if(data.map && data.map.length===VISIBLE_ROWS){ snapshot(); level=data.map; draw(); } else alert('Bad JSON'); } catch(err){alert('Error reading JSON:'+err)}
  };
  r.readAsText(f);
};

// --- Export PNG
document.getElementById('exportBtn').onclick=()=>{
  const ex=document.createElement('canvas');
  ex.width=canvas.width; ex.height=canvas.height;
  const ectx=ex.getContext('2d'); ectx.imageSmoothingEnabled=false; ectx.drawImage(canvas,0,0);
  ex.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='level.png'; a.click(); });
};

// --- Camera scroll
window.addEventListener('keydown', e=>{
  if(e.key==='ArrowLeft'){ cameraX=Math.max(0,cameraX-1); draw(); }
  if(e.key==='ArrowRight'){ cameraX=Math.min(TOTAL_COLS-VISIBLE_COLS,cameraX+1); draw(); }
});

// --- Playtest (placeholder)
let playing=false;
function drawPlayer(){ ctx.fillStyle='red'; ctx.fillRect(0,canvas.height-TILE_H*scale,TILE_W*scale,TILE_H*scale); }
function startPlay(){ playing=true; document.getElementById('playBtn').disabled=true; document.getElementById('stopBtn').disabled=false; draw(); drawPlayer(); }
function stopPlay(){ playing=false; document.getElementById('playBtn').disabled=false; document.getElementById('stopBtn').disabled=true; draw(); }
document.getElementById('playBtn').onclick=startPlay;
document.getElementById('stopBtn').onclick=stopPlay;

// --- Theme tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    theme=t.dataset.theme;
    buildPalette();
  };
});
</script>
</body>
</html>
