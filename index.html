<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>SMB NES Tileset Editor</title>
  <style>
    body { margin:0; display:flex; background:#222; color:#ddd; font-family:sans-serif; }
    #sidebar { width:220px; background:#2b2b2b; padding:10px; box-sizing:border-box; }
    #sidebar button, #sidebar input { width:100%; margin:4px 0; }
    #palette { display:grid; grid-template-columns: repeat(4, 48px); gap:4px; margin-bottom:10px; }
    .pal { width:48px; height:48px; border:1px solid #555; background:#000; cursor:pointer; image-rendering: pixelated; }
    .pal.selected { border:2px solid #0af; }
    #preview { width:64px; height:64px; border:1px solid #555; background:#000; margin-bottom:10px; image-rendering: pixelated; }
    #canvasWrap { flex:1; background:#5c94fc; overflow:auto; }
    canvas { image-rendering: pixelated; display:block; border:4px solid #000; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Tileset</h3>
    <div id="palette"></div>
    <div id="preview"></div>

    <h4>Tools</h4>
    <button id="paintBtn">Paint</button>
    <button id="eraseBtn">Erase</button>
    <button id="pickBtn">Pick</button>
    <button id="fillBtn">Fill</button>
    <hr/>
    <button id="clearBtn">Clear Level</button>
    <button id="undoBtn">Undo</button>
    <button id="redoBtn">Redo</button>
    <hr/>
    <button id="saveBtn">Download JSON</button>
    <button id="loadBtn">Load JSON</button>
    <input type="file" id="fileInput" style="display:none"/>
    <button id="exportBtn">Export PNG</button>
    <hr/>
    <button id="playBtn">Playtest</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>
  <div id="canvasWrap">
    <canvas id="editor"></canvas>
  </div>

<script>
// --- Config
const TILESET_URL = 'https://www.spriters-resource.com/resources/sheets/52/52571.png'; // Official SMB tileset :contentReference[oaicite:3]{index=3}
const TILE_W = 16;
const TILE_H = 16;
const VISIBLE_COLS = 28;
const VISIBLE_ROWS = 15;
const TOTAL_COLS = 400;

// --- State
let tilesetImage;
let tiles = []; // each tile as canvas
let palette = [];
let selectedTile = 0;
let tool = 'paint';
let level = [];
let undoStack = [], redoStack = [];

// init level grid
for (let y=0; y<VISIBLE_ROWS; y++){
  level[y] = Array(TOTAL_COLS).fill(-1);
}

// --- Setup canvas
const canvas = document.getElementById('editor');
const ctx = canvas.getContext('2d');
let cameraX = 0;
let scale = 2;
function resizeCanvas(){
  canvas.width = VISIBLE_COLS * TILE_W * scale;
  canvas.height = VISIBLE_ROWS * TILE_H * scale;
}
resizeCanvas();

// --- Load & slice tileset
tilesetImage = new Image();
tilesetImage.crossOrigin = 'anonymous';
tilesetImage.onload = () => {
  const cols = Math.floor(tilesetImage.width / TILE_W);
  const rows = Math.floor(tilesetImage.height / TILE_H);
  let idx = 0;
  for (let ry=0; ry<rows; ry++){
    for (let rx=0; rx<cols; rx++){
      const c = document.createElement('canvas');
      c.width = TILE_W; c.height = TILE_H;
      const cctx = c.getContext('2d');
      cctx.imageSmoothingEnabled = false;
      cctx.drawImage(tilesetImage,
                     rx*TILE_W, ry*TILE_H, TILE_W, TILE_H,
                     0,0, TILE_W, TILE_H);
      tiles.push(c);
      idx++;
    }
  }
  buildPalette();
  draw();
};
tilesetImage.src = TILESET_URL;

// --- Build palette UI
const paletteDiv = document.getElementById('palette');
function buildPalette(){
  paletteDiv.innerHTML = '';
  tiles.forEach((tile, i) => {
    const d = document.createElement('div');
    d.className = 'pal';
    d.dataset.idx = i;
    const c = document.createElement('canvas');
    c.width = TILE_W*2; c.height = TILE_H*2;
    c.style.width = (TILE_W*2)+'px';
    c.style.height = (TILE_H*2)+'px';
    const pc = c.getContext('2d');
    pc.imageSmoothingEnabled = false;
    pc.drawImage(tile,0,0);
    d.appendChild(c);
    d.onclick = ()=>{
      selectedTile = i;
      document.querySelectorAll('.pal').forEach(x=>x.classList.remove('selected'));
      d.classList.add('selected');
      updatePreview();
    };
    paletteDiv.appendChild(d);
  });
  // select first
  paletteDiv.firstChild.click();
}

function updatePreview(){
  const prev = document.getElementById('preview');
  prev.innerHTML = '';
  const c = document.createElement('canvas');
  c.width = TILE_W * scale * 2;
  c.height = TILE_H * scale * 2;
  c.style.width = c.width+'px';
  c.style.height = c.height+'px';
  c.style.imageRendering = 'pixelated';
  const pc = c.getContext('2d');
  pc.imageSmoothingEnabled = false;
  pc.drawImage(tiles[selectedTile],
               0,0,TILE_W,TILE_H,
               0,0, c.width, c.height);
  prev.appendChild(c);
}

// --- Drawing level
function draw(){
  ctx.imageSmoothingEnabled = false;
  ctx.fillStyle = '#75baff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  for (let y=0; y<VISIBLE_ROWS; y++){
    for (let vx=0; vx<VISIBLE_COLS; vx++){
      const lx = vx + cameraX;
      const t = level[y][lx];
      if (t >= 0){
        const tc = tiles[t];
        ctx.drawImage(tc,
          0,0, TILE_W,TILE_H,
          vx*TILE_W*scale, y*TILE_H*scale,
          TILE_W*scale, TILE_H*scale);
      }
    }
  }
  // optional grid lines
  ctx.strokeStyle = 'rgba(0,0,0,0.15)';
  for (let x=0; x<=VISIBLE_COLS; x++){
    const px = x*TILE_W*scale + 0.5;
    ctx.beginPath(); ctx.moveTo(px,0); ctx.lineTo(px,canvas.height); ctx.stroke();
  }
  for (let y=0; y<=VISIBLE_ROWS; y++){
    const py = y*TILE_H*scale + 0.5;
    ctx.beginPath(); ctx.moveTo(0,py); ctx.lineTo(canvas.width,py); ctx.stroke();
  }
}

// --- Mouse / paint logic
let isDown = false;
canvas.addEventListener('mousedown', e=>{
  isDown = true;
  handlePaint(e);
  window.addEventListener('mousemove', handlePaint);
});
window.addEventListener('mouseup', ()=>{ isDown = false; window.removeEventListener('mousemove', handlePaint); });

function handlePaint(e){
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const vx = Math.floor(mx / (TILE_W*scale));
  const vy = Math.floor(my / (TILE_H*scale));
  const lx = vx + cameraX;
  if (lx < 0 || lx >= TOTAL_COLS || vy < 0 || vy >= VISIBLE_ROWS) return;

  if (tool === 'paint'){
    level[vy][lx] = selectedTile;
    draw();
  }
  else if (tool === 'erase'){
    level[vy][lx] = -1;
    draw();
  }
  else if (tool === 'pick'){
    const t = level[vy][lx];
    if (t >= 0){
      selectedTile = t;
      document.querySelector(`[data‑idx='${t}']`).click();
    }
  }
  else if (tool === 'fill'){
    const target = level[vy][lx];
    flood(lx, vy, target, selectedTile);
    draw();
  }
}

function flood(sx, sy, target, repl){
  const stack = [[sx, sy]];
  while (stack.length){
    const [x,y] = stack.pop();
    if (x<0||x>=TOTAL_COLS||y<0||y>=VISIBLE_ROWS) continue;
    if (level[y][x] !== target) continue;
    level[y][x] = repl;
    stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
  }
}

// --- Tool buttons
document.getElementById('paintBtn').onclick   = ()=>setTool('paint');
document.getElementById('eraseBtn').onclick  = ()=>setTool('erase');
document.getElementById('pickBtn').onclick   = ()=>setTool('pick');
document.getElementById('fillBtn').onclick   = ()=>setTool('fill');
function setTool(t){
  tool = t;
  document.querySelectorAll('#sidebar button').forEach(b=>b.classList.remove('active'));
  document.getElementById(t+'Btn').classList.add('active');
}

// --- Clear / undo / redo
function snapshot(){
  undoStack.push(level.map(r=>r.slice()));
  if (undoStack.length > 50) undoStack.shift();
}
document.getElementById('clearBtn').onclick = ()=>{
  if (!confirm('Clear entire level?')) return;
  snapshot();
  for (let y=0;y<VISIBLE_ROWS;y++) for (let x=0;x<TOTAL_COLS;x++) level[y][x] = -1;
  draw();
};
document.getElementById('undoBtn').onclick = ()=>{
  if (!undoStack.length) return;
  redoStack.push(level.map(r=>r.slice()));
  level = undoStack.pop();
  draw();
};
document.getElementById('redoBtn').onclick = ()=>{
  if (!redoStack.length) return;
  undoStack.push(level.map(r=>r.slice()));
  level = redoStack.pop();
  draw();
};

// --- Save / Load
document.getElementById('saveBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify({cols:TOTAL_COLS, rows:VISIBLE_ROWS, map:level})], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'level.json';
  a.click();
};
document.getElementById('loadBtn').onclick = ()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange = e=>{
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try {
      const data = JSON.parse(r.result);
      if (data.map && data.map.length === VISIBLE_ROWS){
        snapshot();
        level = data.map;
        draw();
      } else alert('Bad JSON');
    } catch(err) { alert('Error reading JSON:'+err) }
  };
  r.readAsText(f);
};

// --- Export PNG (visible viewport)
document.getElementById('exportBtn').onclick = ()=>{
  const ex = document.createElement('canvas');
  ex.width = canvas.width; ex.height = canvas.height;
  const ectx = ex.getContext('2d');
  ectx.imageSmoothingEnabled = false;
  ectx.drawImage(canvas,0,0);
  ex.toBlob(b=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = 'level.png';
    a.click();
  });
};

// --- Scroll camera with arrow keys
window.addEventListener('keydown', e=>{
  if (e.key==='ArrowLeft') cameraX = Math.max(0, cameraX-1), draw();
  if (e.key==='ArrowRight') cameraX = Math.min(TOTAL_COLS - VISIBLE_COLS, cameraX+1), draw();
});

// --- Playtest (very simple)
// just draws red player rectangle bottom‑left, no physics
let playing = false;
function drawPlayer(){
  // basic placeholder
  const pw = TILE_W*scale, ph = TILE_H*scale;
  ctx.fillStyle = 'red';
  ctx.fillRect(0, canvas.height - ph, pw, ph);
}

function startPlay(){
  playing = true;
  document.getElementById('playBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  draw();
  drawPlayer();
}
function stopPlay(){
  playing = false;
  document.getElementById('playBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
  draw();
}

document.getElementById('playBtn').onclick = startPlay;
document.getElementById('stopBtn').onclick = stopPlay;

</script>
</body>
</html>
